!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 2.2.4 (r2308) - 03/04/2008 10:03
!  
!  Differentiation of computeforcesadj in reverse (adjoint) mode:
!   gradient, with respect to input variables: cdadj cladj xadj
!                wadj cmzadj cmyadj cmxadj
!   of linear combination of output variables: cdadj cladj cmzadj
!                cmyadj cmxadj
!
!     ******************************************************************
!     *                                                                *
!     * File:          computeForcesAdj.f90                            *
!     * Author:        C.A.(Sandy) Mader, Andre C. Marta               *
!     *                Seongim Choi
!     * Starting date: 12-14-2007                                      *
!     * Last modified: 12-27-2007                                      *
!     *                                                                *
!     ******************************************************************
!
SUBROUTINE COMPUTEFORCESADJ_B(xadj, xadjb, wadj, wadjb, padj, iibeg, &
&  iiend, jjbeg, jjend, i2beg, i2end, j2beg, j2end, mm, cfxadj, cfyadj, &
&  cfzadj, cmxadj, cmxadjb, cmyadj, cmyadjb, cmzadj, cmzadjb, yplusmax, &
&  refpoint, cladj, cladjb, cdadj, cdadjb, nn, level, sps, cfpadj, &
&  cmpadj, righthanded)
  USE blockpointers
  USE inputtimespectral
  USE bctypes
  USE inputphysics
  USE communication
  USE flowvarrefstate
  IMPLICIT NONE
!!$      
!(xAdj, &
!         iiBeg,iiEnd,jjBeg,jjEnd,i2Beg,i2End,j2Beg,j2End, &
!         mm,cFxAdj,cFyAdj,cFzAdj, &
!         cMxAdj,cMyAdj,cMzAdj,yplusMax,refPoint,CLAdj,CDAdj,  &
!        nn,level,sps,cFpAdj,cMpAdj)
!
!     ******************************************************************
!     *                                                                *
!     * Computes the Force coefficients for the current configuration  *
!     * for the finest grid level and specified time instance using the*
!     * auxiliar routines modified for tapenade. This code calculates  *
!     * the result for a single boundary subface and requires an       *
!     * outside driver to loop over mm subfaces and nn domains to      *
!     * calculate the total forces and moments.                        *
!     *                                                                *
!     ******************************************************************
!
! ie,je,ke
! procHalo(currentLevel)%nProcSend, myID
! equations
! nTimeIntervalsSpectral!nTimeInstancesMax
! EulerWall, ...
!nw
!
!     Subroutine arguments.
!
  INTEGER(KIND=INTTYPE), INTENT(IN) :: mm, nn, level, sps
  INTEGER(KIND=INTTYPE), INTENT(IN) :: iibeg, iiend, jjbeg, jjend
  INTEGER(KIND=INTTYPE), INTENT(IN) :: i2beg, i2end, j2beg, j2end
  REAL(KIND=REALTYPE), DIMENSION(3) :: refpoint
  REAL(KIND=REALTYPE) :: yplusmax
!, cFvAdj, cMvAdj 
  REAL(KIND=REALTYPE), DIMENSION(3) :: cfpadj, cmpadj
  REAL(KIND=REALTYPE), DIMENSION(0:ie, 0:je, 0:ke, 3) :: xadj
  REAL(KIND=REALTYPE), DIMENSION(0:ie, 0:je, 0:ke, 3) :: xadjb
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb, nw) :: wadj
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb, nw) :: wadjb
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb) :: padj
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb) :: padjb
! notice the range of x dim is set 1:2 which corresponds to 1/il
  REAL(KIND=REALTYPE), DIMENSION(ntimeintervalsspectral) :: cladj, cdadj&
&  , cfxadj, cfyadj, cfzadj, cmxadj, cmyadj, cmzadj
  REAL(KIND=REALTYPE), DIMENSION(ntimeintervalsspectral) :: cladjb, &
&  cdadjb, cmxadjb, cmyadjb, cmzadjb
!
!     Local variables.
!
  REAL(KIND=REALTYPE), DIMENSION(2, iibeg:iiend, jjbeg:jjend, 3) :: &
&  siadj
  REAL(KIND=REALTYPE), DIMENSION(2, iibeg:iiend, jjbeg:jjend, 3) :: &
&  siadjb
! notice the range of y dim is set 1:2 which corresponds to 1/jl
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, 2, jjbeg:jjend, 3) :: &
&  sjadj
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, 2, jjbeg:jjend, 3) :: &
&  sjadjb
! notice the range of z dim is set 1:2 which corresponds to 1/kl
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 2, 3) :: &
&  skadj
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 2, 3) :: &
&  skadjb
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 3) :: normadj
!add to allow for scaling!
  REAL(KIND=REALTYPE), DIMENSION(3) :: cfpadjout, cfvadjout
  REAL(KIND=REALTYPE), DIMENSION(3) :: cfpadjoutb
  REAL(KIND=REALTYPE), DIMENSION(3) :: cmpadjout, cmvadjout
  REAL(KIND=REALTYPE), DIMENSION(3) :: cmpadjoutb
  LOGICAL, INTENT(IN) :: righthanded
  INTEGER(KIND=INTTYPE) :: i, j, k, l, kk
!
!     ******************************************************************
!     *                                                                *
!     * Begin execution.                                               *
!     *                                                                *
!     ******************************************************************
!
!===============================================================
! Compute the forces.
! Compute the surface normals (normAdj which is used only in 
! visous force computation) for the stencil
! Get siAdj,sjAdj,skAdj,normAdj
  CALL GETSURFACENORMALSADJ(xadj, siadj, sjadj, skadj, normadj, iibeg, &
&                      iiend, jjbeg, jjend, mm, level, nn, sps, &
&                      righthanded)
  CALL COMPUTEFORCESPRESSUREADJ(wadj, padj)
! Integrate force components along the given subface
!end if invForce
! Compute the force components for the current block subface
  cmpadjoutb(:) = 0.0
  cmpadjoutb(3) = cmzadjb(sps)
  cmzadjb(sps) = 0.0
  cmpadjoutb(2) = cmpadjoutb(2) + cmyadjb(sps)
  cmyadjb(sps) = 0.0
  cmpadjoutb(1) = cmpadjoutb(1) + cmxadjb(sps)
  cmxadjb(sps) = 0.0
  cfpadjoutb(:) = 0.0
  cfpadjoutb(1) = dragdirection(1)*cdadjb(sps)
  cfpadjoutb(2) = dragdirection(2)*cdadjb(sps)
  cfpadjoutb(3) = dragdirection(3)*cdadjb(sps)
  cdadjb(sps) = 0.0
  cfpadjoutb(1) = cfpadjoutb(1) + liftdirection(1)*cladjb(sps)
  cfpadjoutb(2) = cfpadjoutb(2) + liftdirection(2)*cladjb(sps)
  cfpadjoutb(3) = cfpadjoutb(3) + liftdirection(3)*cladjb(sps)
  cladjb(sps) = 0.0
  CALL FORCESANDMOMENTSADJ_B(cfpadj, cmpadj, cfpadjout, cfpadjoutb, &
&                       cmpadjout, cmpadjoutb, yplusmax, refpoint, siadj&
&                       , siadjb, sjadj, sjadjb, skadj, skadjb, normadj&
&                       , xadj, xadjb, padj, padjb, wadj, iibeg, iiend, &
&                       jjbeg, jjend, i2beg, i2end, j2beg, j2end, level&
&                       , mm, nn)
  CALL COMPUTEFORCESPRESSUREADJ_B(wadj, wadjb, padj, padjb)
  CALL GETSURFACENORMALSADJ_B(xadj, xadjb, siadj, siadjb, sjadj, sjadjb&
&                        , skadj, skadjb, normadj, iibeg, iiend, jjbeg, &
&                        jjend, mm, level, nn, sps, righthanded)
END SUBROUTINE COMPUTEFORCESADJ_B
