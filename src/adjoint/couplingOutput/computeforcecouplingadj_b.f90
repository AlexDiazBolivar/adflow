!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 2.2.4 (r2308) - 03/04/2008 10:03
!  
!  Differentiation of computeforcecouplingadj in reverse (adjoint) mode:
!   gradient, with respect to input variables: forceloc machadj
!                alphaadj xadj wadj betaadj
!   of linear combination of output variables: forceloc
!
!     ******************************************************************
!     *                                                                *
!     * File:          computeForceCouplingAdj.f90                     *
!     * Author:        C.A.(Sandy) Mader                               *
!     * Starting date: 08-17-2008                                      *
!     * Last modified: 08-17-2008                                      *
!     *                                                                *
!     ******************************************************************
!
SUBROUTINE COMPUTEFORCECOUPLINGADJ_B(xadj, xadjb, wadj, wadjb, padj, &
&  iibeg, iiend, jjbeg, jjend, i2beg, i2end, j2beg, j2end, mm, yplusmax&
&  , refpoint, nsurfnodesloc, forceloc, forcelocb, nn, level, sps, &
&  righthanded, secondhalo, alphaadj, alphaadjb, betaadj, betaadjb, &
&  machadj, machadjb, machcoefadj, prefadj, rhorefadj, pinfdimadj, &
&  rhoinfdimadj, rhoinfadj, pinfadj, murefadj, timerefadj, pinfcorradj, &
&  liftindex, ii)
  USE blockpointers
  USE inputtimespectral
  USE bctypes
  USE inputphysics
  USE communication
  USE flowvarrefstate
  IMPLICIT NONE
!end if invForce
!!$      
!(xAdj, &
!         iiBeg,iiEnd,jjBeg,jjEnd,i2Beg,i2End,j2Beg,j2End, &
!         mm,cFxAdj,cFyAdj,cFzAdj, &
!         cMxAdj,cMyAdj,cMzAdj,yplusMax,refPoint,CLAdj,CDAdj,  &
!        nn,level,sps,cFpAdj,cMpAdj)
!
!     ******************************************************************
!     *                                                                *
!     * Computes the Force coefficients for the current configuration  *
!     * for the finest grid level and specified time instance using the*
!     * auxiliar routines modified for tapenade. This code calculates  *
!     * the result for a single boundary subface and requires an       *
!     * outside driver to loop over mm subfaces and nn domains to      *
!     * calculate the total forces and moments.                        *
!     *                                                                *
!     ******************************************************************
!
! ie,je,ke
! procHalo(currentLevel)%nProcSend, myID
! equations
! nTimeIntervalsSpectral!nTimeInstancesMax
! EulerWall, ...
!nw
!
!     Subroutine arguments.
!
  INTEGER(KIND=INTTYPE), INTENT(IN) :: mm, nn, level, sps
  INTEGER(KIND=INTTYPE), INTENT(IN) :: iibeg, iiend, jjbeg, jjend
  INTEGER(KIND=INTTYPE), INTENT(IN) :: i2beg, i2end, j2beg, j2end
  INTEGER(KIND=INTTYPE) :: liftindex
  INTEGER(KIND=INTTYPE) :: nsurfnodesloc, ii
  REAL(KIND=REALTYPE), DIMENSION(3, nsurfnodesloc) :: forceloc
  REAL(KIND=REALTYPE), DIMENSION(3, nsurfnodesloc) :: forcelocb
  REAL(KIND=REALTYPE), DIMENSION(3) :: refpoint
  REAL(KIND=REALTYPE) :: yplusmax
  REAL(KIND=REALTYPE), DIMENSION(0:ie, 0:je, 0:ke, 3) :: xadj
  REAL(KIND=REALTYPE), DIMENSION(0:ie, 0:je, 0:ke, 3) :: xadjb
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb, nw) :: wadj
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb, nw) :: wadjb
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb) :: padj
  REAL(KIND=REALTYPE), DIMENSION(0:ib, 0:jb, 0:kb) :: padjb
! notice the range of x dim is set 1:2 which corresponds to 1/il
  REAL(KIND=REALTYPE), DIMENSION(3) :: veldirfreestreamadj
  REAL(KIND=REALTYPE), DIMENSION(3) :: veldirfreestreamadjb
  REAL(KIND=REALTYPE), DIMENSION(3) :: liftdirectionadj
  REAL(KIND=REALTYPE), DIMENSION(3) :: dragdirectionadj
  REAL(KIND=REALTYPE) :: machadj, machcoefadj, uinfadj, pinfcorradj
  REAL(KIND=REALTYPE) :: machadjb, uinfadjb, pinfcorradjb
  REAL(KIND=REALTYPE), DIMENSION(nw) :: winfadj
  REAL(KIND=REALTYPE), DIMENSION(nw) :: winfadjb
  REAL(KIND=REALTYPE) :: prefadj, rhorefadj
  REAL(KIND=REALTYPE) :: pinfdimadj, rhoinfdimadj
  REAL(KIND=REALTYPE) :: rhoinfadj, pinfadj
  REAL(KIND=REALTYPE) :: murefadj, timerefadj
  REAL(KIND=REALTYPE) :: alphaadj, betaadj
  REAL(KIND=REALTYPE) :: alphaadjb, betaadjb
!
!     Local variables.
!
  REAL(KIND=REALTYPE), DIMENSION(2, iibeg:iiend, jjbeg:jjend, 3) :: &
&  siadj
  REAL(KIND=REALTYPE), DIMENSION(2, iibeg:iiend, jjbeg:jjend, 3) :: &
&  siadjb
! notice the range of y dim is set 1:2 which corresponds to 1/jl
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, 2, jjbeg:jjend, 3) :: &
&  sjadj
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, 2, jjbeg:jjend, 3) :: &
&  sjadjb
! notice the range of z dim is set 1:2 which corresponds to 1/kl
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 2, 3) :: &
&  skadj
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 2, 3) :: &
&  skadjb
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 3) :: normadj
  REAL(KIND=REALTYPE), DIMENSION(iibeg:iiend, jjbeg:jjend, 3) :: &
&  normadjb
  LOGICAL, INTENT(IN) :: righthanded, secondhalo
  INTEGER(KIND=INTTYPE) :: i, j, k, l, kk
!
!     ******************************************************************
!     *                                                                *
!     * Begin execution.                                               *
!     *                                                                *
!     ******************************************************************
!
!===============================================================
! Compute the forces.
!      call the initialization routines to calculate the effect of Mach and alpha
  CALL ADJUSTINFLOWANGLEFORCECOUPLINGADJ(alphaadj, betaadj, &
&                                   veldirfreestreamadj, &
&                                   liftdirectionadj, dragdirectionadj, &
&                                   liftindex)
  CALL PUSHREAL8ARRAY(veldirfreestreamadj, 3)
  CALL CHECKINPUTPARAMFORCECOUPLINGADJ(veldirfreestreamadj, &
&                                 liftdirectionadj, dragdirectionadj, &
&                                 machadj, machcoefadj)
  CALL PUSHREAL8(rhorefadj)
  CALL PUSHREAL8(prefadj)
  CALL REFERENCESTATEFORCECOUPLINGADJ(machadj, machcoefadj, uinfadj, &
&                                prefadj, rhorefadj, pinfdimadj, &
&                                rhoinfdimadj, rhoinfadj, pinfadj, &
&                                murefadj, timerefadj)
!referenceStateAdj(velDirFreestreamAdj,liftDirectionAdj,&
!      dragDirectionAdj, Machadj, MachCoefAdj,uInfAdj,prefAdj,&
!      rhorefAdj, pinfdimAdj, rhoinfdimAdj, rhoinfAdj, pinfAdj,&
!      murefAdj, timerefAdj)
!(velDirFreestreamAdj,liftDirectionAdj,&
!     dragDirectionAdj, Machadj, MachCoefAdj,uInfAdj)
  CALL SETFLOWINFINITYSTATEFORCECOUPLINGADJ(veldirfreestreamadj, &
&                                      liftdirectionadj, &
&                                      dragdirectionadj, machadj, &
&                                      machcoefadj, uinfadj, winfadj, &
&                                      prefadj, rhorefadj, pinfdimadj, &
&                                      rhoinfdimadj, rhoinfadj, pinfadj&
&                                      , murefadj, timerefadj, &
&                                      pinfcorradj)
  CALL PUSHREAL8ARRAY(skadj, (iiend-iibeg+1)*(jjend-jjbeg+1)*2*3)
  CALL PUSHREAL8ARRAY(sjadj, (iiend-iibeg+1)*2*(jjend-jjbeg+1)*3)
  CALL PUSHREAL8ARRAY(siadj, 2*(iiend-iibeg+1)*(jjend-jjbeg+1)*3)
! Compute the surface normals (normAdj which is used only in 
! visous force computation) for the stencil
! Get siAdj,sjAdj,skAdj,normAdj
!      print *,'getting surface normals'
  CALL GETSURFACENORMALSCOUPLINGADJ(xadj, siadj, sjadj, skadj, normadj, &
&                              iibeg, iiend, jjbeg, jjend, mm, level, nn&
&                              , sps, righthanded)
!     print *,'computing pressures'
  CALL COMPUTEFORCECOUPLINGPRESSUREADJ(wadj, padj)
  CALL PUSHREAL8ARRAY(padj, (ib+1)*(jb+1)*(kb+1))
  CALL PUSHREAL8ARRAY(wadj, (ib+1)*(jb+1)*(kb+1)*nw)
!    print *,'applyingbcs'
  CALL APPLYALLBCFORCECOUPLINGADJ(winfadj, pinfcorradj, wadj, padj, &
&                            siadj, sjadj, skadj, normadj, iibeg, iiend&
&                            , jjbeg, jjend, i2beg, i2end, j2beg, j2end&
&                            , secondhalo, mm)
!   print *,'integrating forces'
! Integrate force components along the given subface
  CALL FORCESCOUPLINGADJ_B(yplusmax, refpoint, siadj, siadjb, sjadj, &
&                     sjadjb, skadj, skadjb, normadj, xadj, padj, padjb&
&                     , wadj, iibeg, iiend, jjbeg, jjend, i2beg, i2end, &
&                     j2beg, j2end, level, mm, nn, machcoefadj, forceloc&
&                     , forcelocb, nsurfnodesloc, ii)
  CALL POPREAL8ARRAY(wadj, (ib+1)*(jb+1)*(kb+1)*nw)
  CALL POPREAL8ARRAY(padj, (ib+1)*(jb+1)*(kb+1))
  CALL APPLYALLBCFORCECOUPLINGADJ_B(winfadj, winfadjb, pinfcorradj, &
&                              pinfcorradjb, wadj, wadjb, padj, padjb, &
&                              siadj, siadjb, sjadj, sjadjb, skadj, &
&                              skadjb, normadj, normadjb, iibeg, iiend, &
&                              jjbeg, jjend, i2beg, i2end, j2beg, j2end&
&                              , secondhalo, mm)
  CALL COMPUTEFORCECOUPLINGPRESSUREADJ_B(wadj, wadjb, padj, padjb)
  CALL POPREAL8ARRAY(siadj, 2*(iiend-iibeg+1)*(jjend-jjbeg+1)*3)
  CALL POPREAL8ARRAY(sjadj, (iiend-iibeg+1)*2*(jjend-jjbeg+1)*3)
  CALL POPREAL8ARRAY(skadj, (iiend-iibeg+1)*(jjend-jjbeg+1)*2*3)
  CALL GETSURFACENORMALSCOUPLINGADJ_B(xadj, xadjb, siadj, siadjb, sjadj&
&                                , sjadjb, skadj, skadjb, normadj, &
&                                normadjb, iibeg, iiend, jjbeg, jjend, &
&                                mm, level, nn, sps, righthanded)
  CALL SETFLOWINFINITYSTATEFORCECOUPLINGADJ_B(veldirfreestreamadj, &
&                                        veldirfreestreamadjb, &
&                                        liftdirectionadj, &
&                                        dragdirectionadj, machadj, &
&                                        machcoefadj, uinfadj, uinfadjb&
&                                        , winfadj, winfadjb, prefadj, &
&                                        rhorefadj, pinfdimadj, &
&                                        rhoinfdimadj, rhoinfadj, &
&                                        pinfadj, murefadj, timerefadj, &
&                                        pinfcorradj, pinfcorradjb)
  CALL POPREAL8(prefadj)
  CALL POPREAL8(rhorefadj)
  CALL REFERENCESTATEFORCECOUPLINGADJ_B(machadj, machadjb, machcoefadj, &
&                                  uinfadj, uinfadjb, prefadj, rhorefadj&
&                                  , pinfdimadj, rhoinfdimadj, rhoinfadj&
&                                  , pinfadj, murefadj, timerefadj)
  CALL POPREAL8ARRAY(veldirfreestreamadj, 3)
  CALL CHECKINPUTPARAMFORCECOUPLINGADJ_B(veldirfreestreamadj, &
&                                   veldirfreestreamadjb, &
&                                   liftdirectionadj, dragdirectionadj, &
&                                   machadj, machcoefadj)
  CALL ADJUSTINFLOWANGLEFORCECOUPLINGADJ_B(alphaadj, alphaadjb, betaadj&
&                                     , betaadjb, veldirfreestreamadj, &
&                                     veldirfreestreamadjb, &
&                                     liftdirectionadj, dragdirectionadj&
&                                     , liftindex)
END SUBROUTINE COMPUTEFORCECOUPLINGADJ_B
